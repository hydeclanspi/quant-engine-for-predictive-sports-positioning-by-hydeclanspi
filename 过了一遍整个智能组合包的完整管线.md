Now I have a complete picture of the entire pipeline. Let me formulate my analysis:

------

OK，我逐一过了一遍整个智能组合包的完整管线，从概率计算→组合生成→效用评分→MMR重排序→仓位优化→Portfolio包→Monte Carlo。以下是我发现的所有问题，按严重程度排序：

------

## 🔴 问题1（数学纰漏）：Entry Correlation 修正方式有误

**位置**: ComboPage.jsx L1859-1883

**当前做法**: 把 phi 相关系数乘以 `corrScale` (0.04) 后**加性修正**联合概率 `p`：

```js
p = clamp(p + avgCorrAdj, 0.02, 0.98)
```

**问题**: 联合概率的相关性修正应该是**乘性**的，不是加性的。当概率本身很低时（比如 0.05），加性修正 +0.03 是 60% 的相对变化，这个幅度是不合理的。当概率很高时（0.80），同样的 +0.03 只是 3.75% 的变化。加性修正使得低概率组合受到的影响远大于高概率组合，这在统计学上是错误的。

**正确做法**: 用乘性修正：`p = p * (1 + avgCorrAdj)`，这样相同的相关系数对不同概率的组合产生等比例的影响。

------

## 🟡 问题2（统计瑕疵）：Monte Carlo 中 combo 之间被假设为独立的

**位置**: ComboPage.jsx L367-382 (`runPortfolioMonteCarlo`)

**当前做法**: MC 模拟中，每个 combo 的每条 leg 独立采样 `rand() >= combo.legProbs[l]`。不同 combo 如果共享同一场比赛，这场比赛在不同 combo 中会被**独立采样两次**——这意味着同一场比赛可能在 combo A 中命中但在 combo B 中没命中。

**问题**: 这违反了物理现实——同一场比赛的结果是唯一的。如果曼城 vs 利物浦出现在 combo 1 和 combo 3 中，它们应该共享同一个随机结果。当前的独立采样会**低估**组合包的相关性风险，使 VaR 看起来比实际好。

**正确做法**: 先在 match 级别采样一次结果（per unique match → one random draw），然后所有 combo 共享该 match 的结果。

------

## 🟡 问题3（算法效率）：Portfolio optimizer 的梯度投影可能不收敛

**位置**: ComboPage.jsx L1710-1741 (`optimizePortfolioWeights`)

**当前做法**: 固定 learning rate (0.16) 的投影梯度上升，180 次迭代。

**问题**: 固定 step size 在接近最优解时可能会"振荡"——超过最优点然后被投影回来，导致不收敛。对于带 box constraint + simplex constraint 的二次规划，学习率应该递减，或者使用更稳健的优化方法。

**影响**: 目前通过 `projectCappedSimplex` 的投影能保证可行性，但最终解可能不是真正最优的——离最优解可能差 5-15%。

**改进方案**: 加入学习率衰减（`lr * (1 - iter/maxIter)`），成本很低。

------

## 🟢 问题4（边界情况）：Histogram 边界 bug

**位置**: ComboPage.jsx L405 (`runPortfolioMonteCarlo`)

```js
const idx = Math.min(4, Math.floor((pnls[i] - minPnl) / bucketWidth))
```

**问题**: 当 `minPnl === maxPnl`（所有模拟结果完全相同，比如所有组合全输），`bucketWidth = 0`，导致 `0/0 = NaN`，`Math.floor(NaN) = NaN`，`Math.min(4, NaN) = NaN`。虽然极端情况，但会导致 histogram 计数全为 0。

------

## 🟢 问题5（精度改进）：xorshift32 PRNG 质量

**位置**: ComboPage.jsx L361

当前的 seed 初始化把所有 leg 概率 XOR 在一起，这意味着如果两个不同的 portfolio 凑巧有相同的概率 XOR 和，它们会产生完全相同的 MC 结果。改进方案：加入 combo 数量和 stake 信息。

------

我来修这些问题？问题1（相关性修正）和问题2（MC 共享采样）是数学层面的实质性错误，问题3是收敛性改进，问题4和5是小 bug。